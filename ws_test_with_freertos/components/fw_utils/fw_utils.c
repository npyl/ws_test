/*----------------------------------------------------------------------------\
|          Copyright(c) 2025 Jerry Pylarinos.                                 |
|          This program is protected by copyright and information             |
|          contained therein is confidential. The program may not be          |
|          copied and the information may not be used or disclosed            |
|          except with the written permission of the proprietor(s).           |
|                                                                             |
|-----------------------------------------------------------------------------|
|                                                                             |
|   Module Name  : fw_utils.c Module File.                                    |
|                                                                             |
|   Author       : Jerry Pylarinos                                            |
|                                                                             |
|   Date         : 26 …·Ì 2025                                                |
|                                                                             |
|-----------------------------------------------------------------------------|
|                                                                             |
|   <Module Description>                                                      |
|                                                                             |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Compiler Controls                                                         |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Header Files                                                              |
\----------------------------------------------------------------------------*/

#include <stdint.h>

#include "fw_utils.h"

/*----------------------------------------------------------------------------\
|   Public Constant Definitions                                               |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Public Data Definitions                                                   |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Private Type Definitions                                                  |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Private Constant Definitions                                              |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Private Data Declarations                                                 |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Private Function Declarations                                             |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   Public Function Implementations                                           |
\----------------------------------------------------------------------------*/

void delayMicroseconds( uint32_t microseconds )
{
    static uint8_t initialized = 0;

    // Initialize timer on first use
    if ( !initialized )
    {
        // Stop RTI
        rtiREG1->GCTRL = 0x0;

        // Configure for microsecond counting (RTICLK = 80MHz)
        rtiREG1->CNT[0].CPUCx = 79;  // Divide by 80 for 1MHz

        // Enable counter 0
        rtiREG1->GCTRL |= 0x1;

        initialized = 1;
    }

    uint32_t start = rtiREG1->CNT[0].FRCx;
    uint32_t target = start + microseconds;

    if ( target < start )
    {
        while ( rtiREG1->CNT[ 0 ].FRCx >= start ) ;
        while ( rtiREG1->CNT[ 0 ].FRCx < target ) ;
    }
    else
    {
        while ( rtiREG1->CNT[ 0 ].FRCx < target ) ;
    }
}

/*----------------------------------------------------------------------------\
|   Private Function Implementations                                          |
\----------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------\
|   End of fw_utils.c module                                                  |
\----------------------------------------------------------------------------*/
